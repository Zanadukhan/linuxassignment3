#!/bin/bash

if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

# install necessary packages.

pkge_installer () {
pacman -S --noconfirm nginx
pacman -S --noconfirm ufw
}

user_file_setup () {
# Create webgen system user
useradd -m -d /var/lib/webgen -r -s /bin/sh webgen

# Create bin and HTML folders
mkdir /var/lib/webgen/{bin,HTML}

# Move generate_index into bin folder
mv generate_index /var/lib/webgen/bin

# Change ownership to webgen
chown -R webgen: /var/lib/webgen/ 

chmod 700 /var/lib/webgen/bin/generate_index
}

systemD_setup () {
# Move unit files into /etc/systemd/system
mv unit-files/generate-index.{service,timer} /etc/systemd/system

# Start/enable unit files
systemctl start generate-index.service
systemctl start generate-index.timer

systemctl enable generate-index.service
systemctl enable generate-index.timer

}

nginx_setup () {
# move preconfigured nginx files into webgen's nginx
rm -r /etc/nginx
mv nginx /etc
# replace IP address name in server block
ipv4="server_name $1"
server_name=$(grep server_name /etc/nginx/sites-available/webgen.conf)
sed -i "s/$server_name/$ipv4/" /etc/nginx/sites-available/webgen.conf

systemctl start nginx.service
systemctl enable nginx.service
}

ufw_config () {
# Allow SSH (limit) and HTTP connections through firewall
ufw allow ssh
ufw limit ssh
ufw allow http

# Enable firewall
sudo ufw enable
sudo systemctl enable --now ufw.service
}


main () {
pkge_installer
user_file_setup
systemD_setup
nginx_setup $1
ufw_config

echo Index.html is now being served

}




main $1

